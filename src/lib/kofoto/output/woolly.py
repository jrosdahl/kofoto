import os
from kofoto.outputengine import OutputEngine
from kofoto.common import symlinkOrCopyFile

css = '''
body {
    color: #000000;
    background: #dddddd;
    font-family: Verdana, Geneva, Arial, Helvetica, sans-serif;
    font-size: 10pt;
}

img {
    border-style: none;
    display: block;
}

img.thinborder {
    color: #000000; /* Netscape */
    border-color: #000000; /* IE */
    border-style: solid;
    border-width: 1px;
}

img.toc {
    color: #000000; /* Netscape */
    border-color: #000000; /* IE */
    border-style: solid;
    border-width: 1px;
    margin-top: 0.3cm;
}

img.icon {
    display: inline;
}

.albottom {
    vertical-align: bottom;
}

a.toc {
    display: block;
    align: center;
}

td.arrow {
    font-size: 9pt;
}

a:link {
    color: #24238e;
}

a:visited {
    color: #6b4789;
}

.textleft {
    padding-right: 10pt;
}

.header {
    font-size : 10pt;
    background: #c5c2c0;
    table-layout: fixed;
    border-style: solid;
    border-width: 1px;
    border-color: #000000;
}

.photographer {
    font-size: 9pt;
}

.footer {
    font-size : 9pt;
}

h1 {
    font-size : 15pt;
    margin-bottom: 10
}

h2 {
    font-size: 10pt;
}

td.info {
    background: #c5c2c0;
    border-style: solid;
    border-width: 1px;
    border-color: #000000;
}
'''

transparent_1x1_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\rIDATx\xdac````\x00\x00\x00\x05\x00\x01z\xa8WP\x00\x00\x00\x00IEND\xaeB`\x82"

frame_bottom_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x11\x08\x06\x00\x00\x00\x1c\xc3\xc6\x12\x00\x00\x001IDATx\xda\x8d\xc9A\r\x000\x0c\x03\xb1S\x07\'$\x072*\x8abHGa\xfe\x1aI\xc6vH\xb2\x05P\xdd\xcd\x99\x99\x8b\xed\xfd\x8cE\x92\x01\xf4\x00#%(P\xc8\xc2\x05\'\x00\x00\x00\x00IEND\xaeB`\x82"

frame_bottomleft_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x0c\x00\x00\x00\x11\x08\x06\x00\x00\x00\xe9=M\xa2\x00\x00\x01\x1fIDATx\xda\x95\x921n\xc2@\x10E\xdf$\x16\xe3\xca\x1d\xdd\xbaa$$\x9c:\xd7H\xc9!h\xa1\xe6\x06n)9\x83\x8f\xc1\x01R\x11\x96&%=b\x91\x92I\x918\xb2\xc0(\xe4K\xa3\xd5\x8e\xf4\xf6k\xff\x8cL\xa7\xd3\xd7\xe5rYUU%\x001F\xe6\xf3y\x8a1\xbe\x03\x89\x0be\xdd\x8b\x88P\x96%u]kJ\xc9\xe8Qv\xd9PU\xcc\x0c@z\x01w\x07\xa0=\xffR\x96R\xf2\x18\xa3\xbb;\"\xbf\x8f\xcaM \xcf\xf3\xb8^\xaf\x19\x0c\x06\"\"\x9cN'=\x1c\x0e\xe5p8\xd4<\xcf\xaf\x00\xd9n\xb7v>\x9f\x15\x10wg\xbf\xdf\xdbj\xb5\xaag\xb3\x99\x8dF#\xe9\xb8~;\x8c\xc7\xe3\xd8m4M\x83\xaa&3c2\x99p\x05\\Z.\x16\x0b\x8a\xa2\xb8\x19\xc2\x15\xb0\xdb\xed\xdc\xcc<\xc6\xe8\xedl\xbaA\xf4\xa5a\xaaZ\x87\x10LU\xdb?\xa8\xaa\x96!\x04\xedsU\xc0\x80\nx\xfa\xa9\x173{k\x9a\xe63\xeb\x01\x12\x10{6 \x99\x19\x0f\xfcS\xf7\x02\xden\xc4\xe3\x9d@q<\x1e\x9f7\x9b\xcd\x87\xdc\t(\x10\x00\xfd\x02\xb3\xd4h/\"\xda\xec\xa7\x00\x00\x00\x00IEND\xaeB`\x82"

frame_bottomright_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x11\x00\x00\x00\x11\x08\x06\x00\x00\x00;mG\xfa\x00\x00\x00\xd2IDATx\xda\xa5\x931\n\x840\x10E\x7f\x96@\xbc\x84\x95\x9d\xb9\x8b\xa5\x17\xd9\xde\xc2\xde\xdb\x05\x1b\x89U\x0e\xb1c\x91\xbf\xcd\xba\xac\xacY\x8d;\x10Bf\xe0\xc1<\xf2\xd14\xcdc\x9a&\xc6\x18\x19c\xa4s\x8em\xdb\xd29w\xd4\x8b\xd6Z\x07\xc0\xde\x86a0eYB)\x85\xab\xa5\xab\xaa\xfa\x0b\x00\x00\x1a\x00Hb\xef>\r\x19\xc7\xf1\xfd \x89y\x9e!\"y\x90\xbe\xef7\x90eYP\x14\x05\x8c1\xe7!]\xd7}5\x8d1Xe\x9fYM\xd7u\xbd;\xc8\x91\xadS\x83\x1c\xd9\x1b\xb1)\xd8\x91\xec\x8d\xd8\x14\xe4H\xf6\xae\xd8\xbd\xfa%;)6G\xb6\xce\xf9T\x9f\x92\xd7\xb3\x8aenVH\xc2{O\x11!\x00\xaaW\x9c\xb3!\"\xc2\x10\x82\x17\x91\xbb\x02`/\x86\x97\x00\x04@x\x02\xb7\x89\xa5\xf8\x0b\xe9\xfe\xce\x00\x00\x00\x00IEND\xaeB`\x82"

frame_left_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x06\x00\x00\x00\x01\x08\x06\x00\x00\x00\xfd\xc9\xdf\xf0\x00\x00\x00\x1fIDATx\xda\x05\xc1\x01\x01\x00\x00\x08\xc20\xfb\xd0\x87\xe4\xcfs\xdc\xae-\x80\xea\xd4\x01&\xe1\x01\xe4\xbc\x12\x12\xcbp\xe9\x92\x00\x00\x00\x00IEND\xaeB`\x82"

frame_right_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x11\x00\x00\x00\x01\x08\x06\x00\x00\x008\xbbEa\x00\x00\x00(IDATx\xda\x85\xc8A\x01\x000\x10\xc20\xfc\xe0\xe7\x94WO\x99\x84\xe5\x99\xb4\x05P\x9d:`w7`\x9f\xb3-I\xfa\x00N\xd33\x8ef\xbf\xfbs\x00\x00\x00\x00IEND\xaeB`\x82"

frame_top_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x06\x08\x06\x00\x00\x00\x02\x10\xf41\x00\x00\x00$IDATx\xda\x05\xc1\x01\x11\x00\x00\x08\x02\xb1?\xeb\xd8\x87\xe4\x1cq\xd0\rI\xc6vi{\x030I\x8e\xdd\xf5\x03\xe1\xef\x0e$\xd4\n|5\x00\x00\x00\x00IEND\xaeB`\x82"

frame_topleft_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x06\x00\x00\x00\x06\x08\x06\x00\x00\x00\xe0\xcc\xefH\x00\x00\x00\x06bKGD\x00\xff\x00\xff\x00\xff\xa0\xbd\xa7\x93\x00\x00\x00\tpHYs\x00\x00\x0b\x12\x00\x00\x0b\x12\x01\xd2\xdd~\xfc\x00\x00\x00\x07tIME\x07\xd3\x05\x01\x0e3\x1b\\\xb2\xad\xe2\x00\x00\x00TIDATx\x9c]\x89\xb1\r\xc0 \x10\x03m\x84`\x0f\xbe\"\x03\xb1\x00#\xb0Xv\xfa%pE*\xa2\x90\x93\\\xf8\x8e\xad\xb5[\x92\xa5\x94H\x12\x9b8\xe7\xb4\xde\xfbUJ9C\xce\x99f\xc6Z\xeb\x11\xc2>$\xdf\x01@\xc4\x0fIpw\x84\xaf\\k\xc1\xdd1\xc6\xd0\x03E\xd4\x18G\xcb:X\x17\x00\x00\x00\x00IEND\xaeB`\x82"

frame_topright_png = "\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x11\x00\x00\x00\x0c\x08\x06\x00\x00\x00\x84%V\xbf\x00\x00\x01\x15IDATx\xda\x8d\x91\xb1j\x84@\x10\x86\xffM\xc4\x01S]awi\\-\xf4\xea\x80\xaf\x11H|\x81{\x04\xab4v\x96\xf7\x08\xf6\xd7\xddk\xa4?\xdb\x11$vW\xa4\x13f\xe1\xd84&\x98\x9c\x86\xfd\x9b\x85\x9f\xe1c\xe7\x1bU\x14E\x8b)\xd6Z\x18c,\x11q]\xd7e\x92$\x0c\x87xUUesH\xd7u\xb6i\x1a\x88\x08\xc11^\x96ej\x0eQJ\x81\x88\x14\x00\xe5\x0c\x01\x00\xa5n\xe7\xad\xb5\xae\x0c\xdc13D\xe4W)\"\xc4\xcc\xfat:\xed\xb4\xd6;\x00\x19\x00\r`q\xc5\xfb\xbe\xef\xdf\xf2<\xf76\x9b\r\x00\xe0r\xb9\xa8\xe3\xf1\xf8\xd0\xb6m~>\x9f\x9f\x8d1\xafA\x10\xbc\x8c\xe3\xf8t\xbd^\xdf\x01|\xde\xac\xc3\xcc\x1f\"\xa2\xe7\x0e\xc20\xa4\xfd~\xaf\xa3(\x02\x000\xb3-\xcb\x12\xccLkN\xe4oID\xd0Z\xab4M\xe7\xdd\xaalo\xa9\xfc\x16=\x7f\x97\xe4\xff\x0bY\tMr\x7f\x0e8m1\xb8B\x14\x11=\xc6q|\xf0}_\xa6\x0b\xdaa\x18XDJ\xe7\x9fl\xb7\xdbU\xd9_0\xf6t\x96\x1c\xda\xaaL\x00\x00\x00\x00IEND\xaeB`\x82"

previous_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x06\x00\x00\x00\xe0w=\xf8\x00\x00\x02\xe9IDATx\xda\xed\x95\xdfk\x14W\x14\xc7?\xf7\xce\xdd\x9d\x89\xc6l6\x9b4\r\xdd\xd1\nb\x7f\xc5\xa4\x92\x8d\xd6\xb6\xfb\x94\xa7\x8aP\xa4}\xf5\xd97\xf1--\xf4\x1f(H\xff\x80\xfe\x03\x82},\xf4\xb5\xbe\x08\x01\xf1E\xd0RJIL\x8a\xf9\xd9\xae\xd9d\x92\xdd\x99\xb9\xf7\xf8\xb0\x93fL\xb2b\x1a\x04\x1fz\xe00s\xbf\xcc9\xdf\xef\x9cs\x0f\x07\xfe\xb7#\x9a\x0fT\xb3\xe7\x7f2\xdd\x05W\xc0\t\xa0\x0e|\x03T5\x05\xfa\t\xd1\x14\x8eL\xa0\x81>M\xa1\xdeO\xf8\x9d\xc1\xffDS\xf0G\x06\xc6\x98\x98\xfa\x92!\xef\xf4\x91\x084pBS\xa8\x8fT\xc6\xbf\x9d\x98\xbaz\xa1\xe2\x9d\n\x8e\xf1\xb6\x0e?\xfe\x94\xb7F\xaa\x18\xa3\x0fE`\x0eJ>X>7=y\xe5Z\xed\xd4\xf0\x90\xff\xe7\xfd_\x83\xd5\xe6\xec\x99\xdf\xef\xfe\xc2|\xd1\xb0\xd6\x9e\x07\x90\xc3\x12\xe8N\xcd\xfdz\xb9\xf4\xd1\xf4\xf9/\xae\xd5&&.\x05\xba\xf5\x8c\xe10\xac\x9a\xa7\xde-\xa0%\xa2\x08\x83\xf7\x01\xd7i\x94R\x88\xa8\x7f\xcfyK\x93\x84\xc5h\x16\xb5\xab\xbc\xa7>X\x9a\x9c>\x7f\xf9\xeb\xda\xc5\xc9\x8b\xc1\xc8@\tl\xca\xd6\xfa\x1a\xe2\x12\x01p\x0eD\x04\x11\xc1\xf3\x14J\xa9}\xd8\xce\xf9\xef\xe5\x05\xee\xfc\xf8\x03\x06\xe8S\x14>\x1f\xea\xfbp\xfa\xd2\xe5\xafj\xe3\x93\x17\x82J\xa97\xbbK\x9a\x9e\xf20\x1aT\xbe[J\x14"\xc2>Le\x95s\x10Em\x946\x18PS=\xe6\xcc\xcdw?\xbbZ;yv,(\x18\x9f\xa8\x95\x00\t\xd0Q\x83\x02\'\x9dw%\x1d\xe5J\xcb>\xcc\xe1P\xa2\xc0Acc\x9b\xd8Z\x0c\xf4\xde0\x95\xb3\xe3\xb1\x19\x08\x1e/<\xe3\x8f\xc5\r\x94V/\xd4S\xdc\x9e\x9eZ\x07\x9e\xee\x8a)\'\xb4\x96\xd7\xd8\xder\x18\xd8\xbc\x1d-?<\xf6\xe4\xd1\xe0\xb9(\x1c\xf3\xfd\xe3\xc7Q\xca\xeb~-,\x08\x82B\x81w\x00\x06h\r\xb2\x19\x91\x92\xe2\x01\xb1\xb0\xbe\x147\x1aa*A\xc5\xf8%\xa3\x95\x878\x87M\x1d6\xb1\xd84\xe7\xd6\xe2\xac\xc3\xda.\x98\xb5H\xea\x90$\xa2\xb1\xf0\x00\x03\xac\x80\xccX\xe6\xd4\xc6\xfc\xdd\xeb\xc0\xe8@8\xea\x17\xfd^l\x92\xb0\xbd\xbe\x8a\xb5\x89\x1cj\xb8\x8c\xc6\xd8&\x96\x18\x034;}\x97\x19\xcb\x1c;$\xe5w>\xf0\xdb[\x1b\xfc\xf3\xe8\xe78\xb5\xabK@\x9coK\xe6\xf6\xc0!\x00<\x1cmV0@kw2wI\x9cs\xa3\x85b\xa9\x98\xda\xe5\xa5\x94\xc5\xef\x81\'\xb9\xe4.\x8b\xdb|1>7h\xb9Iv@;\'n\xc62G\xf4\x97\xbb^\xec\x7fo\xd4\xd2\xda\x02\x1e\x02\xbf\xedQ\x9ff\xc9\x93\x97\x95\xcb\xdb\xa3\xcaf\x01\r\xa1\xb9\x98\xb6V\xaa\xd0t\xc0O\xc0\xd3\xacL\xed\xcc\xe3\xec{^\x85 O\x92f\xc1+\x10\xcff\xcb\xe6\x1e\x10e\x7f\xbc\xa3\xde\xbdJ\xc3U\x17Lg\xee\x03e`-K\xaa3\xd5\xe9\xebZ\xa1\xea\x8d[\xea\xcf\x01\x1d]c\xf9\x04\xab]4\x00\x00\x00\x00IEND\xaeB`\x82'

noprevious_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x04\x00\x00\x00J~\xf5s\x00\x00\x01\xa4IDATx\xda\xbd\x94=o\x131\x18\x80\x1f\xdf\xf9zn\xc9uh\xa5\n\xb5\x01\xa1\x941\x08!\x9d\xba\xd0H\x95\xfa_\xe8\x86:\x11\x98\x98\x91\xf8\x1f\xfc\x0f\x96\xb2!\xb10\x03C#\x14!\xa5\xb9\x92\xfb\xb2_\x868\x1fmr\x88.\xd8\x83_\xcb\xef\xf3\xda\xef\x97\xd5[\xee6\x02\xfe7\x10\xd3&\xfeW@\x91\xd0\xe35m\x85F5\x00z\tM\xd4\xf3\xf0\x95m\x11\xdf\xe3>\xdf)\xffzC@\xa2z\xad7\x8f\x8e"\x13\x04{\xb4\x1a\x9d\xd3\x0b\xf5\xad\xfea\x9a\xc4\x97\xa6z\xfc\x83\x90\x02\xa4\t\x08H\xe8m\xf6;\xe9\xbe\xb1l\xb7\x83\xf7\xe4\x10\xadQ\xb6L\xd03\xeb\x9d\xf4\xc0\x18\x84g\xb1t@\x10@\xa1\xe6\x92\x00\x19\x9f\xd1ls\xbc\xd9?L\xf7\x8d\xf1qUM\x01\xa2D\xa19\x8d\xce\x0f\xd2\x1d\x13P\x03\xb3\x87O\xad.$\xf1\x80C\xab\x97\xe6\xa92#\xc6\xf3\xc8\xcb|U7$aB\x8d\x96\x0f\xd7[\xc3\'e\x1c\xddJ\x95\xf8\\.\x0c(*\x84\xf0\xa4\x94A\xf1\x80\xddPO\x1dt~\xca|\'K\xf2\x98\xf0D\xf1K~\x96\x0f\xd5\xae\xd6\x01\x8e\x9cR*\xd6MK\xcd5\x9a+\x1c\x9f\x1c\xa33\xba\xad\xb8fX\xda\x81\xaf\nA\xb0\xb8\xe5\x87:49\x02SD\xba\xe1\x86\x1d\xb8w|\x03\x04GN\xe6\xcf\x972\xed(`\x8a\\\x9d\x99\xae\xfc\xe6\x0b_\xbd\xfd\x9a\x9cj\xb54f\xc8\x85s\x93\x17\x12\x91\x91\x01\xce\xfb\xb9\xb6\xf8\x1c\x05\x82\xe3\xa3\x8c9\xa5`\x03EI\xb9\xaa\xbe\xe8\x07GA\xc5\x88K.\x18R\x13\xdcvw\xb5\x81\x04\x8b\xa5"\xf3Y\x92\xbb}\x02\xd2T\x80\x7f\x00ze\xbb\xd3\xcbU!\x10\x00\x00\x00\x00IEND\xaeB`\x82'

next_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x06\x00\x00\x00\xe0w=\xf8\x00\x00\x02\xefIDATx\xda\xed\x95\xcfo\x1bE\x14\xc7?ow\xd6^\xe7\x07\x8e\x1a\xc7!!-T\x8d*\xd4F\x10\tC#\x0e\x1czE=p\x01\xeeH\xdc\xe0\x80\x84\xfc\xb7\x94\x0b\x07\x0e\x08\xa9\'\xa4rAH@\x11\xbf\x8a\xa8\x94\xa6\xd0\x1e\x80\x92\x04\xa5i\x9c\xb8\xae\xbd\xde\xec\xda3\x8f\x83\xd7&?ER\x84\xc4\x81\xaf4\x9a}O\xb3\xdf\xef\x9b\xf7f\xde\xc0\xff\xf8\x17\x91\x07f\xb2\xf9P\xf8\xc7a\xf4\x08(\xf2\x04)1\x8a{\nx\x17\x88\x81\r\xa0\xf3\x8f\x05\xca\xfe,\xf3\x17_&it\x88\xe2\xda\x94O\xf0\xd6cL/\xa4\xc4\xab\x8a\xbb\x9f\x89\xe8#\x0b\x8c\xe5&8w\xe1%\xdc\xf0\x18\xf5\xdfV\'\x8b~\xe9\xf5\xf9\x8b\x97\xe6\x92\x87\x9d3Q\xbc\xb1\xa2\xb8{{E\x0cp\xfe\xa8\x02\x1b\xc9\xef\xf2\xc5\x95\xf7\x89\xd3.m\xee\xcd\x96\x86\x9f\x0e\xe7\x9e[\x08Gg\xceT\xbe\xfe\xd8Uk\xf5\x9b8:\xd7\x80&\xe0\x00L\x8e\xc2GS\xc3\xa71Ap`\xd6E\x14U\x1d\xd8\x00C\x05e\x9c\xf3\xe1\xf8\xf4\xf4L\xb9T\x92\xd2\xccl\x18w\\\xe5\x87\xab\x1fT7\x1b\xb7\x80d b\xa6\x86O\x9f{\xf5\xcdw\x18\x9f<\x89\x88\xe0y`\xad""\x03[U\xf7\xf9\x00\xc4\x0bd\xa8X\x02\xdfp\xa1\xf2b\x88\xfa\x95\x1b\x9f\\\xa9\xd6\x1a\xd7q\xc4\xd7\x80\xa6\x11\xcfH8Rfl\xf2T?@D\x05\x95\x1d\xb5r \xb2\xdf\xe7\x00\xb2\xdd\x95\x8a#,<\xffBX@+\xdf\\\x8d\xaa\xf7\x1f.\xa2t\xbe2\xa9\xb5\xd4\x9b1\xf9\xc66x\xa0\xa2xx\xa8**\xbd\xa8=\x01u\xb2\xcf\x87\xf6\x84\xfb\x08L\x9eSg\x9f\t\xd7\x1e\xbcRi~\xda\xae\xb6\xbb\xb7\xf3&n;~\xfa\xa5\xc6\xaf\xad\x10\xf5\xb2\xc5\xd6\x81\xef\xed.\xc7\x01>\xf1d\x97\xadN\xe9t-\xa99\x11\x9a\xf1\xb3\xcf\xb2\xbe\xfa\xb6\xe9\xd2e\xb3\x11!v\x0b\xe7\xb2\x85(\x82\xfcu\x88\xed\x01\xbe\x03\xa0jI\xa2\x88\xda\xcab\x12\xad/\xde\x81\xd6\x87\xc6\xe1\xb0\xd6\xa2\xdb\x1d\xec\xee;r$\x88\x97\xa5P\x95\xed\xb8\xc5\xd6\xcaR\xd2\\\xfe\xfc\xa6\xe5\xeee\xd0\xef\x8d%\xd5\xa8\xb1F\xd7\x8f\xe8v\xdd\xb1\xc8}?\x90Bq\x02?\x08H\x93\x01\xf9\x92\xe5\xee{\xa0\xdf\x025\x01\x7f)O\x19\x8bwx\x0b\xea%F\xb2\xd1G\xce\xf8\x13\x8f\x9f\x98\xbb\x94\xcb\x0f\x8dR\xff\xe3\xe7>\xf9\xe5\x8c|\x1dh\x19\xb0\xaf%\xac\x1d\x9a\x01 \x04F\xb2\xd9\xdb!\xf2$\xd6U\x93f\xe3dks9\x8dV\xbf\xdcK\xde\x04\x12\x03\xdc\xfa\x9bL\x04\x19\xb9\xd9\xb3\x8b\x86e\xbb\xdd\xde\xba\x9d\xa6\x0f\xee,Y\x96\xf7\x91\xf7\xdb\xc5\xd1:uO \xc8\xfa\x7f\x1e\x98\x07\xf9\x11F\xbf\x03y\x03\x98\x03\xca@a\xd0S\xb2\x9f\x8e\x82~$\xb9lh/B\xbd\x0e\xcd\xcf\x80\x1b@\x1dh\x01\xe9\xce\xc8\xe5\x98\xa7\xd2d\x05w\xd9w)#\xee\xa7\xc3\xed}\x0f\x1e\x05\xf2\x9fz\xb8\xff\x04\xa7>SM\xfc!\xd6\xb8\x00\x00\x00\x00IEND\xaeB`\x82'

nonext_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x04\x00\x00\x00J~\xf5s\x00\x00\x01\xa7IDATx\xda\xc5\x94\xcfj\x14A\x10\xc6\x7f5[\x99\xe9\x98Y\x0f\x12D\xd9\x15s\xf0\xa4\x07\x11\x06\xf1\xb2\xcf\xe1[x\x1d\x05\xc1\xe7H^@|\x08O\xf1\x10\xf5 b\x14\xc5?\x08\x9e\\\xc4\xb0\x99ug{\xfet{\x98\xd9l4;\x1aO\xf6\xa9(\xbe\xaf\xeb\xab\xaf\xaa[\x1e\xf0o\'\xe0\xff\x12"\x86D\xa7"\x08\x8a\xc0\x90\xbb\x8c\xe8#\x7f%\xac\xb1\xc5\x06\x12\xc9-\xbd/#\xce.qA\x97\xd2\x98\xf3\x04\xc1\x9a\xd9\xba\x19\xdf\x93\x11\xfd\x05R\xb9\xb6\x8a`\xe5-5\xee\x8a1\x17M\x9c\xbcOg\xf8]2\x1c\xa8<Z\xa7\xd7!\x0b\x13\x0f\xcfH\xdf\xd4\xc9\xc7t\x06\xbbd8]\xbfz\x83\x18\x10< \x08\xfe(\x02\x91\x08a`H>\xb5UT$d\xa3\xd3W\x0f\x80a`$\xf9\x90\xce\xe0\x89:\n\xe6\xad\x95\xcd\xcd\x0b\xa0\xb4\xd9\xc6\x84sf\x90|N\xcbH+\xbe\x93#\x80?\xb2{\x19-3\x0e1\xe6zuG=s\xea\xb64-\xf18tA(9\xb4?\xde\xf9\x87\n\x8e\xea\x0f\xdb\xd1\x10K2;y\xe5\xb6y\xa6\xde[\x04\xd7\xb5j\x12\x11P\x91\xd9\xc9\xbe\xdba\x8foZ\xbf\x19\xff>\xe4^\xeb)\x84\xbd\x0b\x9b\xa12\xb5\x93}\xb7\xcd\x1ec\xa6\xcam\xf7\xab\x02C\x8c!@\x80\xcb\xa4\xc5\xa5\xbc8l\xe0_\xc9\xb0\xca\xeb\x13\x036h[c\xe2gy1?\x06\xc7\xe9\t\xd9%5\x01B\x00L}\x9e\xbf\xf4;<e\xdc\xc0AWt\xea\x80\x90\x10\x8f\xe5\xb9\x7f\xcc\x0b\x0e\x98R4\xceH\xc7\'\xa0\xf4p(\x9b\x1c`q\xb8\xc5\xa8\xb4\xc3\xcf\x8a\x1aO\xc9\x97\xd3\xbfi\xbf:\xfd\x13\xa2B\x9dB\xd4Y(\\\x00\x00\x00\x00IEND\xaeB`\x82'

smaller_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x06\x00\x00\x00\xe0w=\xf8\x00\x00\x03\xd8IDATx\xda\xb5\x96\xddk\x14W\x14\xc0\x7f\xf7f\xb2\xd9\x99&&\x9b\x88Q\xb6l\xeaVC\x03\x9aZ\x95\xb4Fe\tm)"M\x0b6\xedC\x1f\n\xedK\xfbP\x1f\x84"\x05\x1f\xf4\x1f\xf0\xd5\xd7>\xf4\xe3A-T\x8a\xa0PJ\x8a\rh\xa9J\x14\xc4t\x93&\x1bMc\xb2\x89\xdbu?f\xe6\xde\xb9\xd3\x87\xd9\x98\x88nRJz\xe02\x87\xb9g\xce\xef\x9cs\xef\xb9w\xe0\x7f\x16Qob\xc7\x8ew\x06\x8b\xc5\xb9!\xad\xdd~ct\xca\x18\r\x90\x03Fl;qvjj\xe4\xc2\x7f\x02\xec\xdb\xf7\xf1\xee\\\xee\xe6i\x90\x99\xde\xde7H$\x0e\xd2\xda\x9a \x0c\x03\x1e>\\\xe0\xc1\x83\x9f\x18\x1d\xbd\x881z\xb8\xad\xed\xf9c\x93\x93\xbf^\xff\xd7\x80\xee\xee7\x07\x0b\x85\x99\xf3\xdd\xdd\x07\xac\x9d;?b\xe3\xc66b1\x0b\x800\x0c\xf1}\x8d\xe7)\xe6\xe6\xe6\xb8q\xe3\x0c\xd9\xec\x15\xed8\xedG\xf2\xf9\xbb\x17\xd6\x04\xec\xda5\xb4\xfb\xde\xbd\x9bW\xfb\xfa\xde\xb7\xf6\xec\xf9\x10\xc7\x89a\xdb\x8d\xb4\xb44a\xdb\x8dX\x96\xc4\x18C\xb1\xe83?_&\x9f/p\xf5\xea\x19\xae_\xff^77oz5\x9f\xbf\xfb\xccL\x1a\x96\x14\xa5\xfc\xef\xb6o?\x98\xced>\xa3\xa5%N"\xe1\xb0ys3\x1b6\xc4\xb0\xed\x06,KbY\x82x<\x82:\x8eCk\xebNfg\xef\xc8\xf9\xf9\xb1\x97\xb4v\xbfz\x16@\x02$\x93{\x07\x8d1\x99\xbe\xbeO\xb1\xed&\xda\xdb\x1d:;\x9f#\x1e\x9744\x08\x84\x10HI\r\x02RJZZ\x1aI\xa77\xb1\x7f\xff\x17\x84\xa1\xc98N\xc7`]@\xa947\xb4w\xef\xbbtvv\xd0\xdc\x1c\xa7\xad-\x8e\x94<v\xbc\xa4/}\xd2\xd8(\x902\x82\xf7\xf6n\xa3\xb7\xf7m\x94\xaa\x0e\xd5\x05h\xed\xf6\'\x93\x87\x88\xc5,Z[\x9b\x000&Z\xd8\xa7\xc5<\xf5~\xeb\xd6#\x18\xa3\xfb\x9f\x05\xb0"g:\xb5eK\'\xf1\xb8\x85\x94\xd1\xc4\xf1\xe3\x1fD\xbb@,o\xb40\x0c\x1f;?q\xe2\xeb\xc7z*\x95\x02H\xad\x02\x08\x10B`Y\x12\xad\rRJ\xc20D\x08\xf1D\xb4\xcb\xbaAk\x83R\x01J\x05h\xad\xebd\xbb\x9cAnz\xfa~:\x99\xec@\xa9\x08v\xea\xd47X\x96|"\x83 \x08\xd1:r^\xa9h\x94\n\xf0}M.\x97%\x0c\x83\\\xdd5\x80pdb\xe2\x1c\xae\xeb\xe3\xba\x06\xd7\xd5x^\x80\xeb\x1a</\xc0\xf3\x02\xaa\xd5\xe5g\xa5\xa2k\xb6\x1a\xd7\xd5d\xb3\xe7\x08C3R\x17 D\xc3\xd9k\xd7\xbe%\x9b\x9d\xa1R\xf1)\x97=*\x15]\xd3\x15\xe5\xb2\xc2\xf3\x14\xa5\x92O\xa5\x12\r\xd7\xd5T\xab\x1e\xe3\xe3\x7fr\xeb\xd6\x0f\x00g\xeb6Z\x10\xf8\xae\x10\xe2\x95\x85\x85\xb1\x17zz\xde"\x08\xc0\xf7u\xad$Q\xe4J\x05\xb8nT\x12\xd7UT\xab>\xa5R\x95\x8b\x17\x8fQ,\xce\x0c\x03_\xae\xd6\xc9\x7f\x0b!G\x0b\x85\xe9O\n\x85Y\x99L\xbe\x86\xd6\x01Ji<O\xe3\xfb\x9aj\xd5\xc7\xf7\xd5\n\xe7e._>\xc9\xc4\xc4/\x1a8\n\xfc\xb1\xeaQ\x11\x86&\x06bxv\xf6\xce\xd0\xd4\xd4o\xd2\xb6{\x88\xc7m</\xaa\xb7\xe7Ee*\x97+\xe4r\xb7\xb9t\xe9\x04\x93\x93W4P\x01\xde\x03\x16\x81\xdf\xd7:\xae\xbb\x80\x0e\x10\xa7\x85\x90\x99\xee\xee\xd7\xd9\xb6\xed\x00\x8e\xb3\x03\x80r\xf9\x06ccW\xc8f\x7f\x06\x18\x06\x8e\x01\xe7\x81D-\xd8<\xf09\xf0\xe3Z\x17N\x17\xf020\x04\xf4\xafh\xa2\x1c0R[\xd0<p\x1f\xa0\xbd\xfd\xc5\xdb\x80X\\\x1c\x97\x80\x02\x0e\xd5\xec\xd6\x94\xaeU\xc6J\x9b\xfc\xc0\xc0Q\x95J\xed\xab\x02\xc5Z\xd9\xba\xd6\xf3\xea\xed\x02\x1e\x1d>|2H\xa73\x1ax\x04\x94\xd6\x13\xb2\x94\x95;0pT%\x12i\xb5\xde\x80\x95\x90\xbf\x80\x00\xc8\x00]b\x9d\xffRVF<\x05\xf0\x0f"\x04\xf1\x97fA\x92\xbf\x00\x00\x00\x00IEND\xaeB`\x82'

nosmaller_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x04\x00\x00\x00J~\xf5s\x00\x00\x02\tIDATx\xda\x95\x94Ok\x13A\x14\xc0\x7f\xb3\xd9\xfckR\x13\xb1J\xad6A=\xa8(\x08\xbdDzi\xc5\x93(\xb9h\xbeH\xbf\x80\x1f@\xc9\x97\xe81\xe4\xd2c\xf1\x92Kn\x16\xa2E\x92C\x90\x8d\x16\x8aM\xbaIK\x12wgw\xc7C\xc7\x92\xa9Q\xea{0\x7f\x98\xf7\xe3\xcd{\xf3\xde\x88\xb7\xfc\x9fX\xb3\x9b\xe5r~\xfbJwQfe\xb6\x9b\xdd\xbeZ\x9e\x07\x88\xdf\x1e\x8ak\xc3*\x1b\xcbdH\xa1\x98r\xc2!\xaa\x91\xdar\xf7\xe6\x02\xd7\xcb\xd3\xfa\x92\xbdB\x9a\x18\x00!!c\xbe3\x08\xe2\xaf\xc7;\xb3\x80\r\xb0\xb26\xaa\xaf\xda\xb7\x88c\x93\xc4\xc6B\xe1\x91$M\xc2>\xa8gJ\xe3\xbd\x0b\xc0\xb0\xbad\xaf\x12\'I\x9a\x18\x02\x85\xc2"A\n\x8b\x89\xedV\xd94\x82\xce\x95\xd5F\x01\x9b4\x19l\x04 \xb0\xb0\x10$\xc8s\x076\xe2e\x03\xf0*\xb7\xc9\x90 \xa9\x8d\xc5\xf9\x91\xc0\xe2\x067\x89*\x06\x10\xad\xe7\x89\x91\x04\xd4\xdc\xcc_C\xad\x1b1\xa8BV_ew\xc6L\x01\xcfP@\x0e\n\x86\x07\x85\xc0""\x9a\xf1p\xb6\x8a\xb4*3\xad\xaawrw\x91\x08\xc1\xf3\xf3\x87WDDHBBF\xd03K\xa3\xd9\'   $ \xd4c\x80\xd4\xf3\x11\xaai\x02\xb5o\xb8H|\xa4\xd6\x10_\x9bK\\\x0e\xa1f\x00aK5:H$\x1e\x12\x1f\x1f\x0f_\xaf|\xba\xa8\x06;\xa6\x07Gm\x1d\x07_\xf0\xf0\xf8\xa9G_\x83mF\x01\xeff\x93\x1c\xdb\x04H\x88\xc6i\xc5\xb5\x92\xd8\x84Z%C:\xb8\x01\x13\xdep\xccG\xb3\x1f\x1c\xd5R\xa5Q\xe3\x13m\x8e\x181\xe2\x07\x1d>s\xda\xa0\xc41\x11\xef\xf9\xca\xab\x0b\xfd\x00\x14yB\x85u\n@\x8f&5\xfa\x1c\xc0\xc2>bb!yASW\xab\x16\x07\x87\x96Q\x15\x0eP\x9cx\xf7r\x83`(\xf8\xc0C\x1cq\x89\x9e.\xb2\xff`\xe1H\r\xa6\x08\x1eY\x97\xea\xfc\xc7m\x99W\xe9\xd4\x1f\x9f\xc0_\xc4\x01\xeew\xfbS\x8b\x97f\x0c\xffB\x8a<=C\x7f\x01\xdf\xb8\xda=\x96"\xc6\xe3\x00\x00\x00\x00IEND\xaeB`\x82'

larger_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x06\x00\x00\x00\xe0w=\xf8\x00\x00\x03\xe4IDATx\xda\xb5\x96]h\x14W\x14\x80\xbf{wv\xdd\x99&&\x9b\x88Q\xb6\xec\xeaVC\x0b\x9a\x8a\x86\xb4Fe\x1b\xda>\x884\x16l\xaaP\xa4\xd0Bi\x1f\xea\x83Z\x05\xc9\x83\xe2\xbb\xafym\xa1\xad\xe0O\xa1R\n\n\xa5\xa4\xd8\x80\x96FQA\xb4k\x9al\x8c\x8d\xc96n\xe3\xfe\xcc\xcc\xbd{\xa7\x0f\xbb\xc6\x14\xf3SJz\xe0\xc2a\xe6\xcc\xf9\xce\xb9\xe7\x9es\x07\xfeg\x11\xf3\xbd\xd8\xb0aw\xf7\xf4\xf4D\x8f\xd6n\xa71:a\x8c\x06\xc8\x02\x03\xb6\x1d;;22p\xe1?\x01\xb6n\xfd`s6{\xfd\x14\xc8t[\xdb\x1b\xc4b;hh\x88\x11\x04\x15\x1e=\xfa\x93\x87\x0f\x7f\xe0\xc6\x8d\xef1F\xf776>\x7fpx\xf8\xe7\xc1\x7f\rhm}\xb3;\x9f\x7fp\xbe\xb5u\xbb\xb5q\xe3\xfb\xacX\xd1H$b\x01\x10\x04\x01\xbe\xaf\xf1<\xc5\xc4\xc4\x04\xd7\xae\xf5\x91\xc9\\\xd6\x8e\xd3\xb4\'\x97\xbbsaQ\xc0\xa6M=\x9b\xef\xdf\xbf~\xa5\xa3\xe3]k\xcb\x96\xf7p\x9c\x08\xb6\x1d\xa6\xbe~\x19\xb6\x1d\xc6\xb2$\xc6\x18\xa6\xa7}&\'\x8b\xe4ry\xae\\\xe9cp\xf0\x1b]W\xb7\xf2\x95\\\xee\xce\x9c\x99\x84\x9e(J\xf9\xa7\xd7\xaf\xdf\x91J\xa7?\xa1\xbe>J,\xe6\xb0jU\x1d\xcb\x97G\xb0\xed\x10\x96%\xb1,A4Z\x85:\x8eCC\xc3F\xc6\xc7o\xcb\xc9\xc9\xbb/j\xed~>\x17@\x02\xc4\xe3\xed\xdd\xc6\x98tG\xc7\xc7\xd8\xf62\x9a\x9a\x1cZZ\x9e#\x1a\x95\x84B\x82\xc3\x87\xf7q\xe4\xc8\xbe\x1a\x04\xa4\x94\xd4\xd7\x87I\xa5V\xb2m\xdbg\x04\x81I;Ns\xf7\xbc\x80Ba\xa2\xa7\xbd\xfdmZZ\x9a\xa9\xab\x8b\xd2\xd8\x18EJ\x10B \xe5\xb3\x9f\x84\xc3\x02)\xab\xf0\xb6\xb6u\xb4\xb5\xbd\x85R\xe5\x9ey\x01Z\xbb\x9d\xf1\xf8N"\x11\x8b\x86\x86e\x00\x18S-\xec\xb3b\x9ey\xbev\xed\x1e\x8c\xd1\x9ds\x01\xac\xaa3\x9dX\xbd\xba\x85h\xd4\x9a\x89\xf8\xe8\xd1\xbd\xd5S \x9e\x1e\xb4C\x87\xf6\xce8\xef\xed\xfdrFO$\x12\x00\x89\x05\x00\x15\x84\x10X\x96Dk\x83\x94\x92 \x08\x10B\xfc#\xda\xa7\xbaAk\x83R\x15\x94\xaa\xa0\xb5\x9e\'\xdb\xa7\x19dGG\xc7R\xf1x3JUa\'N|\x85eI\x84\x10\x1c;\xb6\x0f\x80\x93\'O\xa3u\xd5y\xa9\xa4Q\xaa\x82\xefk\xb2\xd9\x0cAP\xc9\xce[\x03\x08\x06\x86\x86\xce\xe1\xba>\xaekp]\x8d\xe7Up]\x83\xe7U\x00\x03T\xf5r\xb9B\xa9\xa4k\xb6\x1a\xd7\xd5d2\xe7\x08\x0230/@\x88\xd0\xd9\xabW\xbf&\x93y@\xa9\xe4S,z\x94J\xba\xa6+\x8c1\x18c(\x14|J\xa5\xear]M\xb9\xecq\xef\xde\xef\xdc\xbc\xf9-\xc0\xd9\x85:9\x19\nE\xbeX\xb3\xa63\xbd\x7f\x7f\x1f\xe1p\x98PH\x10\x89T\x8bn\x0cH\tJ\x05\x18cfFF\xb1X\xe6\xcc\x99\x8f\x18\x1b\x1b\xec\x07^[\xa8\x93\xff\x12B\xde\xc8\xe7G?\xcc\xe7\xc7e<\xfe*ZWPJ\xe3y\x1a\xdf\xd7\x94\xcb>\xbe\xafp]E\xb9\xecS(\x14\xb9t\xe98CC?i\xe0\x00\xf0\xdb\x82\xa3"\x08L\x04D\xff\xf8\xf8\xed\x9e\x91\x91_\xa4m\xbfD4j\xe3y\xd5\xfd\xf6<U\x8b\xbaD6{\x8b\x8b\x17{\x19\x1e\xbe\xac\x81\x12\xf0\x0e0\x05\xfc\xba\xd8\xb8N\x02\xcd N\t!\xd3\xad\xad\xaf\xb3n\xddv\x1cg\x03\x00\xc5\xe25\xee\xde\xbdL&\xf3#@?p\x108\x0f\xc4j\xc1\xe6\x80O\x81\xef\x16\xbbp\x92\xc0\xcb@\x0f\xd09\xab\x89\xb2\xc0@\xad\xa09`\x0c\xa0\xa9\xe9\x85[\x80\x98\x9a\xba\'\x01\x05\xec\xac\xd9-*\xc9\x05\xd6l\x9b\\W\xd7\x01\x95Hl-\x03\xd3\xb5mK.\xe5\xd5\x9b\x04\x1e\xef\xdau\xbc\x92J\xa55\xf0\x18(,%\xe4IVnW\xd7\x01\x15\x8b\xa5\xd4R\x03fC\xfe\x00*@\x1aH\x8a%\xfeK\x99\x1d\xf1\x08\xc0\xdf\xd1h\xda\xd7\x1a7\xb1i\x00\x00\x00\x00IEND\xaeB`\x82'

nolarger_png = '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x18\x00\x00\x00\x18\x08\x04\x00\x00\x00J~\xf5s\x00\x00\x02\x13IDATx\xda\x95\x94\xcdjSA\x14\x80\xbf\x99\xdc\xfc5\xa9\x89X\xa5V\x9b\xa0.T\x14\x84n\x12\xb2IE7\xa2d\xa3y\x91\xbe\x80\x0f\xa0\xf4%\xba,\xddtU\x7f6\xd9dg\xa1Z\xa4Y\x04\xb9\xd1B1\xff-I\xbcw\xee\xbd\xe3"W\xc9\xd4*\xf5\x1c\x18f\xce\x9c\x8f\xc39s\xce\x88\x97\xfc\x9f\xc8\xd9\xc3b%\xbbq\xa19\xaf\xd2*\xddLo\\\xac\x9c\x05\x88_\x11\xf2+\x83u\xca\x8b\xa4H\xa0\x99p\xcc\x11\xba\x96X\xeb\xef\x9e\t\\\xaeL\xb6\x16\xac%\x92D\x00\xf0\xf1\x19\xf1\x8d\xae\x17}>\xda\x9e\x05,\x80\xa5\x95\xe1\xd6\xb2u\x8d(\x16q,$\x1a\x878Ib\xd6\xe1V\xaa0\xda=\x05\x0c\xd6\x17\xace\xa2\xc4I\x12A\xa0\xd1Hb$\x90\x8c\xad\xfe:\xabF\xd2\x99\x8a.\xe7\xb0H\x92\xc2B\xb0\xc3\x1b$\x12A\x8c,7\xa0\x1c\xad\x18\x80S\xbdN\x8a\x18q\x04 f\xae\x04\x92+\\%\xa8\x1a@P\xca\x12!\x0e\xe83+\x7f\t]2r\xd0\xb94\x16\x02x\xfb\xdb\xbc\x83\x06\x1e\xa2\x81\x0c\xe4\x8c\x08\x1a\x81$ \x98\x890\xdd\x05\xa1j\xb3\xac\xbau|s\x9e\x00\xc1#$\xf0\x0exL@\x80\xc2\xc7g\x08-\xb35\xea\x1d<<<|<\xfc\xf0\xe1<Thi\xa3\xeb&\xb0\xf9\x95>\n\x17\x85B\xa1\xd1\xb8\xa1\xbb\xa2\xcf\x11l\x1a\x80\xbf\xa7k\r\x14\n\x07\x85K\x91".\n\x17\x17\x97&\xba\xc6\xb6\x19\xc1\xd6k=\xef3\x0e\x0e?\xc2u\xea\xecp\xc0\xd0\xe3\xd5l\x91#\xab\x001Q;\xa9\xf6e\x1c\x0b?T\xc5\x80\x06}\x8f1/\xe8\xf1\xc1\x9c\x07[\xef\xe9\xc2\xb0\xf6\x91\x03\xda\x0c\x19\xf2\x9d\x06\x9f8\xa9Q\xa0G\xc0k\xbe\xf0\xec\xd4<\x00y\x1eP\xa5D\x0ehQg\x93\x0e\x870\xb7\x8f\x18K\x14O\xa8\x87\xdd\x1a\x8a\x8d\xcd\x9e\xd1\x156\x90\x1f;\xb72]o x\xcf]lq\x8e\x99\xce\xb3\x7fg\xae\xad\xbb\x13\x04\xf7\xe4\xb9&\xff\xfe\x81\xca\xead\xe2\x8fO\xe0/b\x03\xb7\x9b\x9d\x89\xe4\xa9\x99\xc3\xbf\x90<\xc5)\xfa\x13\x9b\x86\xd8\xee\x8a\xcd\x15\xfd\x00\x00\x00\x00IEND\xaeB`\x82'

album_template = '''<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<link href="woolly.css" type="text/css" rel="stylesheet" />
<title>%(title)s</title>
</head>
<body>
<table cellpadding="3" width="85%%" align="center" cellspacing="0">
<tr><td class="header">%(paths)s</td></tr>
<tr>
<td>
<h1 class="title">%(title)s</h1>
%(description)s
</td>
</tr>
<tr>
<td align="center">
<table cellpadding="20">
%(subalbumentries)s
%(imageentries)s
</table>
</td>
</tr>
<tr>
<td class="footer" colspan="3">
<p>&nbsp;</p>
<hr>
<small>%(blurb)s</small>
</td>
</tr>
</table>
</body>
</html>
'''

thumbnails_frame_template = '''<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<link rel="stylesheet" href="woolly.css" type="text/css" />
</head>
<body>
%(entries)s
</body>
</html>
'''

# At least Opera 6.12 behaves strangely with "text-align: center;" in
# stylesheet, so use align="center" instead.
thumbnails_frame_entry_template = '''<a name="%(number)s"></a>
<a href="%(htmlref)s" class="toc" target="main">
<div align="center">
<img src="%(thumbimgref)s" class="toc" /></div>
</a>
'''

subalbum_entry_template = '''<td align="center" valign="top">
<p>%(title)s</p>
<table border="0" cellspacing="0" cellpadding="0">
<tr>
<td><img class="albottom" src="images/frame-topleft.png" /></td>
<td><img class="albottom" src="images/frame-top.png" width="6" height="6" /></td>
<td><img class="albottom" src="images/frame-top.png" width="%(thumbwidth_minus_6)s" height="6" /></td>
<td class="albottom" rowspan="2"><img class="albottom" src="images/frame-topright.png" /></td>
</tr>
<tr>
<td rowspan="2"><img class="albottom" src="images/frame-left.png" width="6" height="%(thumbheight)s" /></td>
<td rowspan="2" colspan="2"><a href="%(htmlref)s"><img class="albottom" src="%(thumbimgref)s" width="%(thumbwidth)s" height="%(thumbheight)s"/></a></td>
</tr>
<tr><td><img class="albottom" src="images/frame-right.png" width="17" height="%(thumbheight_minus_6)s" /></td></tr>
<tr>
<td colspan="2"><img class="albottom" src="images/frame-bottomleft.png" /></td>
<td><img class="albottom" src="images/frame-bottom.png" width="%(thumbwidth_minus_6)s" height="17" /></td>
<td><img class="albottom" src="images/frame-bottomright.png" /></td>
</tr>
</table>
</td>
'''

image_entry_template = '''<td align="left" valign="bottom">
<a href="%(frameref)s">
<img class="thinborder" src="%(thumbimgref)s" />
</a>
</td>
'''

image_frameset_template = '''<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<link rel="stylesheet" href="woolly.css" type="text/css" />
<title>%(albumtitle)s</title>
</head>
<frameset cols="100%%, 200">
<frame name="main" src="%(imageframeref)s" />
<frame name="toc" src="%(thumbnailsframeref)s#%(imagenumber)s" marginheight="20" />
<noframes>
This album needs frames. Sorry.
</noframes>
</frameset>
</html>
'''

image_frame_template = '''<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<link href="woolly.css" type="text/css" rel="stylesheet" />
<title>%(title)s</title>
</head>
<body>
<table cellpadding="3" width="85%%" align="center" cellspacing="0">
<tr><td class="header">%(paths)s</td></tr>
<tr>
<td>

<table width="100%%">
<tr>
<td></td>
<td>
<table width="100%%">
<tr>
<td align="left">%(previous)s %(next)s</td>
<td align="right">%(smaller)s %(larger)s</td>
</tr>
</table>
</td>
<td></td>
</tr>
<tr>
<td></td>
<td><img src="images/1x1.png" height="1" width="%(imgmaxwidth)s" /></td>
<td></td>
</tr>
<tr>
<td width="50%%"></td>
<td align="center"><img class="thinborder" src="%(imgref)s" align="center" /></td>
<td width="50%%"></td>
</tr>
<tr><td></td><td class="info">%(description)s</td><td></td></tr>
<tr>
<td></td>
<td class="footer">
<p>&nbsp;</p>
<hr>
<small>%(blurb)s</small>
</td>
<td></td>
</tr>
</table>

</td>
</tr>
</table>
</body>
</html>
'''


class OutputGenerator(OutputEngine):
    def __init__(self, env):
        OutputEngine.__init__(self, env)
        self.env = env


    def generateIndex(self, root):
        symlinkOrCopyFile(
            "%s.html" % root.getTag(),
            os.path.join(self.dest, "index.html"))
        self.writeFile("woolly.css", css)
        for data, filename in [
                (transparent_1x1_png, "1x1.png"),
                (previous_png, "previous.png"),
                (noprevious_png, "noprevious.png"),
                (next_png, "next.png"),
                (nonext_png, "nonext.png"),
                (smaller_png, "smaller.png"),
                (nosmaller_png, "nosmaller.png"),
                (larger_png, "larger.png"),
                (nolarger_png, "nolarger.png"),
                (frame_bottom_png, "frame-bottom.png"),
                (frame_bottomleft_png, "frame-bottomleft.png"),
                (frame_bottomright_png, "frame-bottomright.png"),
                (frame_left_png, "frame-left.png"),
                (frame_right_png, "frame-right.png"),
                (frame_top_png, "frame-top.png"),
                (frame_topleft_png, "frame-topleft.png"),
                (frame_topright_png, "frame-topright.png")]:
            self.writeFile(
                os.path.join(self.imagesdest, filename), data, 1)


    def generateAlbum(self, album, subalbums, images, paths):
        # ------------------------------------------------------------
        # Create album symlink to default size.
        # ------------------------------------------------------------

        self.symlinkFile(
            "%s-%s.html" % (album.getTag(), self.env.defaultsize),
            "%s.html" % album.getTag())

        # ------------------------------------------------------------
        # Create album overview pages, one per size.
        # ------------------------------------------------------------

        for size in self.env.imagesizes:
            # Create path text, used in top of the album overview.
            pathtextElements = []
            for path in paths:
                els = []
                for node in path:
                    els.append('''<a href="%(htmlref)s">%(title)s</a>''' % {
                        "htmlref": "%s-%s.html" % (node.getTag(), size),
                        "title": node.getAttribute("title"),
                        })
                pathtextElements.append(" » ".join(els))
            pathtext = "<br />\n".join(pathtextElements)

            # Create text for subalbum entries.
            if subalbums:
                number = 0
                subalbumtextElements = ["<tr>\n"]
                for subalbum in subalbums:
                    if number % 3 == 0:
                        subalbumtextElements.append("</tr>\n<tr>\n")

                    frontimage = self._getFrontImage(subalbum)
                    if frontimage:
                        thumbimgref = self.getImageReference(
                            frontimage, self.env.thumbnailsize)
                        thumbwidth, thumbheight = self.getLimitedSize(
                            frontimage, self.env.thumbnailsize)
                    else:
                        thumbimgref = os.path.join(self.imagesdest, "1x1.png")
                        thumbwidth = self.env.thumbnailsize
                        thumbheight = 3 * self.env.thumbnailsize / 4

                    subalbumtextElements.append(subalbum_entry_template % {
                        "htmlref": "%s-%s.html" % (subalbum.getTag(), size),
                        "thumbheight": thumbheight,
                        "thumbheight_minus_6": thumbheight - 6,
                        "thumbwidth": thumbwidth,
                        "thumbwidth_minus_6": thumbwidth - 6,
                        "thumbimgref": thumbimgref,
                        "title": subalbum.getAttribute("title"),
                        })
                    number += 1
                subalbumtextElements.append("</tr>\n")
                subalbumtext = "".join(subalbumtextElements)
            else:
                subalbumtext = ""

            # Create text for image entries.
            if images:
                number = 0
                imagetextElements = ["<tr>\n"]
                for image in images:
                    if number % 3 == 0:
                        imagetextElements.append("</tr>\n<tr>\n")
                    imagetextElements.append(image_entry_template % {
                        "frameref": "%s-%s-%s-frame.html" % (album.getId(),
                                                             number,
                                                             size),
                        "thumbimgref": self.getImageReference(
                            image,
                            self.env.thumbnailsize),
                        })
                    number += 1
                imagetextElements.append("</tr>\n")
                imagetext = "".join(imagetextElements)
            else:
                imagetext = ""

            # Album overview.
            self.writeFile(
                "%s-%s.html" % (album.getTag(), size),
                album_template % {
                    "blurb": self.blurb,
                    "description": (album.getAttribute("description") or
                                    album.getAttribute("title")),
                    "imageentries": imagetext,
                    "paths": pathtext,
                    "subalbumentries": subalbumtext,
                    "title": album.getAttribute("title"),
                })

        # ------------------------------------------------------------
        # Create image thumbnails frame, one per size.
        # ------------------------------------------------------------

        for size in self.env.imagesizes:
            # Create text for image thumbnails frame.
            thumbnailsframeElements = []
            number = 0
            for image in images:
                thumbnailsframeElements.append(
                    thumbnails_frame_entry_template % {
                        "htmlref": "%s-%s-%s.html" % (
                            album.getId(),
                            number,
                            size),
                        "number": number,
                        "thumbimgref": self.getImageReference(
                            image,
                            self.env.thumbnailsize),
                        })
                number += 1
            thumbnailstext = "\n".join(thumbnailsframeElements)

            # Image thumbnails frame.
            self.writeFile(
                "%s-%s-thumbnails.html" % (album.getTag(), size),
                thumbnails_frame_template % {"entries": thumbnailstext})


    def generateImage(self, album, image, images, number, paths):
        # ------------------------------------------------------------
        # Create image frameset, one per size.
        # ------------------------------------------------------------

        for size in self.env.imagesizes:
            self.writeFile(
                "%s-%s-%s-frame.html" % (
                    album.getId(),
                    number,
                    size),
                image_frameset_template % {
                    "albumtitle": album.getAttribute("title"),
                    "imageframeref": "%s-%s-%s.html" % (
                        album.getId(),
                        number,
                        size),
                    "imagenumber": number,
                    "thumbnailsframeref": "%s-%s-thumbnails.html" % (
                        album.getTag(),
                        size),
                    })

        # ------------------------------------------------------------
        # Create image frame, one per size.
        # ------------------------------------------------------------

        for sizenumber in range(len(self.env.imagesizes)):
            size = self.env.imagesizes[sizenumber]

            # Create path text, used in top of the image frame.
            pathtextElements = []
            for path in paths:
                els = []
                for node in path:
                    els.append('''<a href="%(htmlref)s" target="_top">%(title)s</a>''' % {
                        "htmlref": "%s-%s.html" % (node.getTag(), size),
                        "title": node.getAttribute("title"),
                        })
                pathtextElements.append(" » ".join(els))
            pathtext = "<br />\n".join(pathtextElements)

            if number > 0:
                previoustext = '<a href="%(htmlref)s"><img class="icon" src="images/previous.png" /></a>' % {
                    "htmlref": "%s-%s-%s.html" % (
                        album.getId(),
                        number + 1,
                        size)}
            else:
                previoustext = '<img class="icon" src="images/noprevious.png" />'

            if number < len(images) - 1:
                nexttext = '<a href="%(htmlref)s"><img class="icon" src="images/next.png" /></a>' % {
                    "htmlref": "%s-%s-%s.html" % (
                        album.getId(),
                        number + 1,
                        size)}
            else:
                nexttext = '<img class="icon" src="images/nonext.png" />'

            if sizenumber > 0:
                smallertext = '<a href="%(htmlref)s" target="_top"><img class="icon" src="images/smaller.png" /></a>' % {
                    "htmlref": "%s-%s-%s-frame.html" % (
                        album.getId(),
                        number,
                        self.env.imagesizes[sizenumber - 1])}
            else:
                smallertext = '<img class="icon" src="images/nosmaller.png" />'

            if sizenumber < len(self.env.imagesizes) - 1:
                largertext = '<a href="%(htmlref)s" target="_top"><img class="icon" src="images/larger.png" /></a>' % {
                    "htmlref": "%s-%s-%s-frame.html" % (
                        album.getId(),
                        number,
                        self.env.imagesizes[sizenumber + 1])}
            else:
                largertext = '<img class="icon" src="images/nolarger.png" />'

            self.writeFile(
                "%s-%s-%s.html" % (
                    album.getId(),
                    number,
                    size),
                image_frame_template % {
                    "blurb": self.blurb,
                    "description": (image.getAttribute("description") or
                                    image.getAttribute("title")),
                    "imgmaxwidth": size,
                    "imgref": self.getImageReference(image, size),
                    "larger": largertext,
                    "next": nexttext,
                    "paths": pathtext,
                    "previous": previoustext,
                    "smaller": smallertext,
                    "title": image.getAttribute("title"),
                    })


    def _getFrontImage(self, object, visited=None):
        if visited and object.getId() in visited:
            return None

        if object.isAlbum():
            if not visited:
                visited = []
            visited.append(object.getId())
            thumbid = object.getAttribute("frontimage")
            if thumbid:
                from kofoto.shelf import ImageDoesNotExistError
                try:
                    return self.env.shelf.getImage(thumbid)
                except ImageDoesNotExistError:
                    pass
            children = object.getChildren()
            if children:
                return self._getFrontImage(children[0], visited)
            return None
        else:
            return object
